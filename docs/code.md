Build & Deployment
=============
* This application will build and publish the application to a container registry. 
* The `build` step is dependent upon a successful infrastructure deployment from the previous section. 
* Using Azure Container Registry built tasks does still require docker to be installed and running. 
* The `build` step will create/switch to a branch in your GitHub repository named after the application name generated by Terraform.
* The `deploy` step will deploy the application by using Helm to generate a template and then commit the template to the GitHub repository.
* Flux will then pick up the changes and deploy the application to Azure Kubernetes Service (AKS).
* The `ui` step will build and deploy the UI code to Azure Static Web Apps (SWA) using the Azure Static Web Apps CLI.

# API Build and Deployment 
### :heavy_check_mark: Steps
- :one: `task build`    - Builds the application using ACR build tasks
- :two: `task deploy`   - Deploys the application to Azure Kubernetes Service (AKS) using Helm template and Flux/GitOps
- :three: `task ui`     - Builds and deploys the UI code to Azure Static Web Apps (SWA) using the Azure Static Web Apps CLI

<p align="right">(<a href="#build--deployment">back to top</a>)</p>

## Example Build Step
```bash
‚ûú  openai-coin-analyzer git:(main) task build
task: [branch] git branch weasel-3444 2>>/dev/null || true
task: [branch] git checkout weasel-3444
Switched to branch 'weasel-3444'
Your branch is up to date with 'origin/weasel-3444'.
task: [build] az acr build -t ric/analyzer-api:6b575834 -r weasel3444acr .
Packing source code into tar to upload...
Uploading archived source code from '/tmp/build_archive_24668ee4e5e449c993be1c578c38f9e7.tar.gz'...
Sending context (51.460 MiB) to registry: weasel3444acr...
Queued a build with ID: cf2
Waiting for an agent...
2025/03/07 16:37:18 Downloading source code...
2025/03/07 16:37:20 Finished downloading source code
2025/03/07 16:37:20 Using acb_vol_afd8caed-9113-4b93-85cc-34ea10171453 as the home volume
...
2025/03/07 16:40:19
- image:
    registry: weasel3444acr.azurecr.io
    repository: ric/analyzer-api
    tag: 6b575834
    digest: sha256:f71d96cd393f70a729b97756bed111263580a7ca26d69d82e8ab9c7ae52b7a6a
  runtime-dependency:
    registry: mcr.microsoft.com
    repository: dotnet/runtime-deps
    tag: 9.0-azurelinux3.0-distroless
    digest: sha256:4d90ab65a65566038518b6109bd4c1f83b92afa6c38aca357642e105e7075772
  buildtime-dependency:
  - registry: mcr.microsoft.com
    repository: dotnet/sdk
    tag: 9.0-noble
    digest: sha256:12e2373b9ea6f904e0d255a54e65eae31d78ae542dc612baa01fe59198e3e22a
  git: {}

Run ID: cf2 was successful after 3m1s
task: [build] git checkout main
Already on 'main'
Your branch is up to date with 'origin/main'.
```
<p align="right">(<a href="#build--deployment">back to top</a>)</p>

## Example Deployment Step
```bash
‚ûú  openai-coin-analyzer git:(main) ‚úó task deploy
task: [branch] git branch weasel-3444 2>>/dev/null || true
task: [branch] git checkout weasel-3444
Switched to branch 'weasel-3444'
Your branch is up to date with 'origin/weasel-3444'.
task: [deploy] helm template ric-analyzer --set ACR.NAME="weasel3444acr.azurecr.io" --set APP.VERSION=486d058a --set APP.TAG_NAME=weasel-3444 --set WORKLOAD_ID.NAME=weasel-3444-app-identity --set WORKLOAD_ID.CLIENT_ID=9b98e3e7-5e12-4a12-b377-7b3349cd4939 --set WORKLOAD_ID.TENANT_ID=16b3c013-d300-468d-ac64-7eda0820b6d3 --set APP_INSIGHTS.CONNECTION_STRING="InstrumentationKey=REDACTED;IngestionEndpoint=https://westus-0.in.applicationinsights.azure.com/;LiveEndpoint=https://westus.livediagnostics.monitor.azure.com/;ApplicationId=REDACTED" --set OPENAI.ENDPOINT=https://weasel-3444-openai.openai.azure.com/ ./charts/api > ./cluster-config/api/components.yaml
task: [deploy] git add ./cluster-config/api/components.yaml || true
task: [deploy] git commit -m "[Fri Mar  7 10:43:36 CST 2025] - Updates for weasel-3444 app ü§ñü§ñü§ñ components" || true
[weasel-3444 6bfb8e7] [Fri Mar  7 10:43:36 CST 2025] - Updates for weasel-3444 app ü§ñü§ñü§ñ components
 1 file changed, 1 insertion(+), 1 deletion(-)
task: [deploy] git push --set-upstream origin weasel-3444 || true
Enumerating objects: 9, done.
Counting objects: 100% (9/9), done.
Delta compression using up to 8 threads
Compressing objects: 100% (5/5), done.
Writing objects: 100% (5/5), 521 bytes | 521.00 KiB/s, done.
Total 5 (delta 3), reused 0 (delta 0), pack-reused 0
remote: Resolving deltas: 100% (3/3), completed with 3 local objects.
To github.com:briandenicola/openai-coin-analyzer.git
   5adc99e..6bfb8e7  weasel-3444 -> weasel-3444
Branch 'weasel-3444' set up to track remote branch 'weasel-3444' from 'origin'.
task: [deploy] git checkout main
Switched to branch 'main'
Your branch is up to date with 'origin/main'.
```
<p align="right">(<a href="#build--deployment">back to top</a>)</p>

# UI Build and Deployment 
## Build and Deploy
```bash
‚ûú  openai-coin-analyzer git:(main) ‚úó task ui
task: [ui] echo EXPO_PUBLIC_API_URL=https://weasel-3444-apim.azure-api.net/api/analyze > .env
task: [ui] echo EXPO_PUBLIC_API_KEY=REDACTED >> .env
task: [ui] npx expo export --platform web
env: load .env
env: export EXPO_PUBLIC_API_URL EXPO_PUBLIC_API_KEY
Starting Metro Bundler
Static rendering is enabled. Learn more: https://docs.expo.dev/router/reference/static-rendering/
Œª Bundled 1173ms node_modules/expo-router/node/render.js (744 modules)
Web Bundled 1640ms node_modules/expo-router/entry.js (834 modules)

‚Ä∫ web bundles (1):
_expo/static/js/web/entry-9fc11802e244dc00739b378e7cbe4ac4.js (1.5 MB)
...
Deploying to environment: production

Deploying project to Azure Static Web Apps...
‚úî Project deployed to https://white-rock-0d379ea10.6.azurestaticapps.net üöÄ

‚ûú  openai-coin-analyzer git:(main) ‚úó 
```
<p align="right">(<a href="#build--deployment">back to top</a>)</p>

# Navigation
[‚è™ Previous Section](../docs/infrastructure.md) ‚Äñ [Return to Main Index üè†](../Readme.md) ‚Äñ [Next Section ‚è©](../docs/testing.md) 
<p align="right">(<a href="#build--deployment">back to top</a>)</p>
